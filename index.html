<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>beetle beater</title>
<style>
/* ---------- base layout ---------- */
* { box-sizing: border-box; user-select: none; -webkit-user-select: none; -ms-user-select: none; }
html,body {
  /* background image layer will sit behind all content */
height:100%}
body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #ffd7a6, #d2a679);
  height: 100vh;
  margin: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  color: #222;
  position: relative;
  transition: background 0.5s ease;
  }

/* full-page background image */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: url('background.png');
  background-size: cover;
  background-position: center center;
  opacity: 0.8;
  pointer-events: none;
  z-index: 0;
}

/* ensure main content stacks above background */
#upgradePanel, #leaderboardPanel, #usernameModal, #infoModal, #raveModal { z-index: 60; }

  text-transform: lowercase;
  padding-top: 50px;
}

/* heading and score */
h1, #score, #comboDisplay { pointer-events: none; }
h1 { font-size: 2.5rem; margin-bottom: 20px; z-index: 2; text-align: center; }
#score { font-size: 2rem; margin-bottom: 30px; z-index: 2; }

/* buttons */
button {
  background-color: #ff8c42;
  color: white;
  border: none;
  border-radius: 1rem;
  padding: 1rem 2rem;
  font-size: 1.2rem;
  cursor: pointer;
  transition: transform 0.1s, background-color 0.2s;
  z-index: 2;
  pointer-events: auto;
  text-transform: lowercase;
  margin: 10px;
}
button:hover { background-color: #ff9b62; }
#panelToggle {
  position: fixed;
  right: 18px;
  top: 18px;
  z-index: 60;
  width:48px;
  height:48px;
  border-radius:12px;
  padding:0;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* upgrade panel */
#upgradePanel {
  position: fixed;
  right: -420px; /* hidden by default */
  top: 0;
  height: 100%;
  width: 420px;
  background: linear-gradient(180deg,#fff8f2,#f3e6d9);
  box-shadow: -8px 0 24px rgba(0,0,0,0.15);
  z-index: 55;
  padding: 20px;
  transition: right 0.32s cubic-bezier(.2,.9,.2,1);
  opacity: 0.5;
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-y: auto;
  text-transform: lowercase;
}
#upgradePanel.open { right: 0; }
#upgradePanel h2 { margin: 6px 0 12px 0; font-size: 1.15rem; text-align:center; }

/* upgrade rows */
.upgrade-row {
  background: linear-gradient(180deg,#fff4ea,#f7efe6);
  border-radius: 12px;
  padding: 12px;
  display:flex;
  align-items:center;
  gap:12px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.06);
}
.upgrade-row img { width:64px; height:64px; object-fit:cover; pointer-events:none; user-drag:none; -webkit-user-drag:none; background: transparent; border: none; }
.upgrade-info { flex:1; display:flex; flex-direction:column; gap:6px; }
.upgrade-info .title { font-weight:700; font-size:1rem; }
.upgrade-info .desc { font-size:0.9rem; color:#444; }
.upgrade-cost { font-weight:900; font-size:1rem; text-align:right; }

/* popup images */
.popup { pointer-events: auto;  z-index: 90; 
  position: absolute;
  width: 100px;
  height: 100px;
  opacity: 0;
  pointer-events: auto;
  transition: opacity 0.28s ease-out, transform 0.28s;
  user-select: none;
  -webkit-user-drag: none;
  border-radius: 0; border: none; box-shadow: none; background: transparent;
  overflow:hidden;
  z-index:30;
}
.popup.show { opacity: 1; transform: scale(1); }
.popup img { width:100%; height:100%; object-fit:cover; display:block; pointer-events:none; background: transparent; border: none; }

/* gold styling for golden popup (visual only) */
.popup.golden { border: none; box-shadow: none; filter: none; }

/* beetle magnet visuals */
.goon-corner { z-index: 40; position: absolute; width: 160px; height: 160px; border-radius: 12px; overflow: hidden; pointer-events: none; background: transparent; border: none; box-shadow: none; transition: opacity 0.5s; }
.goon-corner img { width:100%; height:100%; object-fit:cover; display:block; pointer-events:none; }
.goon-label { pointer-events: none; 
  position: absolute;
  bottom: 8px;
  left: 8px;
  background: rgba(0,0,0,0.6);
  color: white;
  padding: 6px 8px;
  border-radius: 8px;
  font-weight:800;
  font-size: 0.9rem;
  text-transform: lowercase;
  pointer-events:none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

/* central combo display */
#comboDisplay {
  position: absolute;
  top: 45%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 4rem;
  font-weight: 900;
  color: white;
  text-shadow: 0 0 30px rgba(255,192,203,0.9);
  opacity: 0;
  z-index: 41;
  transition: opacity 0.18s, transform 0.18s;
  pointer-events: none;
}

/* golden screen flash overlay */
#goldFlash {
  position: absolute; inset: 0;
  background: radial-gradient(circle at 50% 30%, rgba(255,240,200,0.95), rgba(255,220,80,0.25) 35%, rgba(255,200,0,0.08) 50%, rgba(0,0,0,0) 70%);
  pointer-events: none;
  opacity: 0;
  z-index: 60;
  transition: opacity 0.35s;
}

/* screen flash / particles */
#flash{position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; opacity:0; z-index:1; transition:opacity 0.2s;}
.particle{position:absolute; width:10px; height:10px; border-radius:50%; pointer-events:none; z-index:50;}

/* wiggle */
@keyframes comboWiggle { 0%,100%{transform:translate(-50%,-50%) rotate(0deg);} 25%{transform:translate(-50%,-50%) rotate(5deg);} 50%{transform:translate(-50%,-50%) rotate(-5deg);} 75%{transform:translate(-50%,-50%) rotate(5deg);} }
.combo-wiggle{animation:comboWiggle 0.45s ease-in-out;}

/* rave visuals */
body.rave { animation: raveBG 3s linear infinite; background-size: 400% 400%;}
@keyframes raveBG { 0% { background: linear-gradient(135deg, #ffd7a6, #d2a679); } 25% { background: linear-gradient(135deg, #ffd7a6, #e6c89a); } 50% { background: linear-gradient(135deg, #ffd7a6, #d2a679); } 75% { background: linear-gradient(135deg, #e6c89a, #d2a679); } 100% { background: linear-gradient(135deg, #ffd7a6, #d2a679); } }
  25% { background: linear-gradient(135deg, #ffb3ba, #bde0fe); }
  50% { background: linear-gradient(135deg, #caffbf, #ffd6e0); }
  75% { background: linear-gradient(135deg, #ffdfba, #c7ceea); }
  100% { background: linear-gradient(135deg, #ff9aa2, #ffd3b6); }
}
#raveText {
  position: fixed; top: 18%; left: 50%; transform: translateX(-50%);
  font-size: 3.2rem; font-weight:900; z-index:80; -webkit-background-clip: text; background-clip: text;
  color: transparent; background-image: linear-gradient(90deg, #ff6b6b, #ffcc00, #6bceff, #9bff8a, #ff6b6b);
  text-shadow: 0 6px 24px rgba(0,0,0,0.25); animation: pulse 0.9s ease-in-out infinite; pointer-events:none;
}
@keyframes pulse { 0%{transform:translateX(-50%) scale(0.95)} 50%{transform:translateX(-50%) scale(1.08)} 100%{transform:translateX(-50%) scale(0.95)} }

/* start-the-rave modal */
#raveModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(255,255,255,0.97); border-radius: 18px; padding: 28px; text-align: center; z-index: 90; box-shadow: 0 10px 40px rgba(0,0,0,0.35); color:#222; display:none; }
#raveModal .rave-title { font-size: 1.6rem; font-weight:900; margin-bottom:8px; background: linear-gradient(90deg,#ff6b6b,#ffcc00,#6bceff); -webkit-background-clip:text; color:transparent; }
#raveModal button { font-size:1.25rem; padding:12px 22px; border-radius: 12px; }

/* info modal (intro) */
#infoModal { opacity: 0.95;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: linear-gradient(135deg,#add8e6,#ffc0cb);
  border-radius: 15px;
  padding: 26px;
  text-align: center;
  z-index: 200; /* high so it's above UI until dismissed */
  box-shadow: 0 10px 40px rgba(0,0,0,0.35);
  color: #222;
  max-width: 520px;
  font-size: 1.05rem;
}
#infoModal button { margin-top:15px; background:#ff6b6b; color:white; border:none; padding:10px 20px; border-radius:10px; font-size:1rem; cursor:pointer; text-transform: lowercase; }

/* white can */
#whiteCan {
  position: fixed;
  left: 60px;
  top: 60px;
  width: 72px;
  height: 72px;
  z-index: 195;
  pointer-events: none;
  transform-origin: center;
  transition: transform 0.08s linear;
  will-change: transform, left, top;
  display: none;
}
#whiteCan img { width:100%; height:100%; object-fit:contain; display:block; pointer-events:none; }

/* responsive tweaks */
@media (max-width:600px){
  .goon-corner { z-index: 100;  width:120px; height:120px; }
  .popup { pointer-events: auto;  z-index: 90;  width: 80px; height: 80px; }
  #upgradePanel { width: 320px; right: -320px; }
  #whiteCan{ width:48px; height:48px; }
}

@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

body {
  font-family: 'Press Start 2P', cursive;
}

#gameTitle {
  width: 480px;
  margin-top: 30px;
  animation: titlePulse 3s ease-in-out infinite;
  z-index: 10;
  pointer-events: none;
}

@keyframes titlePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

#clickBtn {
  width: 200px;
  height: 200px;
  cursor: pointer;
  transition: transform 0.1s ease, filter 0.1s ease;
  user-select: none;
}
#clickBtn {
  -webkit-user-drag: none;
  user-drag: none;
  pointer-events: auto;
}

#clickBtn:active {
  transform: scale(0.9);
  filter: brightness(1.3);
}

</style>
</head>
<body>
<img id="gameTitle" src="title.png" alt="beetle beater title" />
<div id="score">beetles <img src="beetle.png" height="16" style="vertical-align:middle;">: 0</div>
<img id="clickBtn" src="button.png" alt="click button" />

<!-- panel toggle -->
<button id="panelToggle" title="upgrades"></button>

<!-- sliding upgrade panel (ordered cheapest -> priciest) -->
<div id="upgradePanel" aria-hidden="true">
  <h2>upgrades</h2>

  <!-- 1: better base beetle -->
  <div class="upgrade-row" id="upgrade-default-row">
    <img src="up.png" alt="combo" />
    <div class="upgrade-info">
      <div class="title">better base beetle</div>
      <div class="desc">increases your default combo (applies when combos reset)</div>
      <div class="desc">current: <span id="baseComboDisplay">1</span></div>
    </div>
    <div>
      <div class="upgrade-cost" id="upgradeCostText">cost: 50</div>
      <button id="upgradeDefaultBtn" style="margin-top:8px;padding:8px 12px;font-size:0.9rem;">buy</button>
    </div>
  </div>

  <!-- 2: beetle magnet -->
  <div class="upgrade-row" id="goon-row">
    <img src="mag.png" alt="beetle magnet" />
    <div class="upgrade-info">
      <div class="title">beetle magnet</div>
      <div class="desc">spawns a beetle magnet image for ~20s — popups spawn more often around it</div>
      <div class="desc">price: base default level × 200</div>
    </div>
    <div>
      <div class="upgrade-cost" id="goonCostText">cost: 200</div>
      <button id="buyGoonBtn" style="margin-top:8px;padding:8px 12px;font-size:0.9rem;">buy</button>
    </div>
  </div>

  <!-- 3: midas -->
  <div class="upgrade-row" id="midas-row">
    <img id="midasImg" src="goldup.png" alt="midas" />
    <div class="upgrade-info">
      <div class="title">golden beetle</div>
      <div class="desc">each purchase +5% golden spawn chance (caps at 100%)</div>
      <div class="desc">current chance: <span id="midasChanceDisplay">0%</span></div>
    </div>
    <div>
      <div class="upgrade-cost" id="midasCostText">cost: 500</div>
      <button id="buyMidasBtn" style="margin-top:8px;padding:8px 12px;font-size:0.9rem;">buy</button>
    </div>
  </div>

  <!-- 4: beetle enchantment / rave (purchase multiple times) -->
  <div class="upgrade-row" id="music-row">
    <img src="music.png" alt="rave music" />
    <div class="upgrade-info">
      <div class="title">beetle enchantment</div>
      <div class="desc">play a 1:48 rave — while it plays everything flashes & wags are x2</div>
      <div class="desc">cost each purchase: baseCombo × <strong>2000</strong></div>
      <div class="desc">owned: <span id="musicOwnedCount">0</span></div>
    </div>
    <div>
      <div class="upgrade-cost" id="musicCostText">cost: 2000</div>
      <button id="buyMusicBtn" style="margin-top:8px;padding:8px 12px;font-size:0.9rem;">buy</button>
    </div>
  </div>

  <!-- 5: orb of beetle crushing -->
  <div class="upgrade-row" id="white-row">
    <img src="orb.png" alt="orb of beetle crushing" />
    <div class="upgrade-info">
      <div class="title">orb of beetle crushing</div>
      <div class="desc">spawns a white can that follows the mouse and auto-pops beetles nearby</div>
      <div class="desc">cost: <span id="whiteCostText">20000</span></div>
      <div class="desc">level: <span id="whiteLevelDisplay">0</span></div>
    </div>
    <div>
      <div class="upgrade-cost" id="whiteCostLabel">cost: 20000</div>
      <button id="buyWhiteBtn" style="margin-top:8px;padding:8px 12px;font-size:0.9rem;">buy</button>
    </div>
  </div>

  <!-- 6: shrine of beetle duplication (most expensive) -->
  <div class="upgrade-row" id="swish-row">
    <img src="add.png" alt="swish" />
    <div class="upgrade-info">
      <div class="title">shrine of beetle duplication</div>
      <div class="desc">adds +1 extra beetle spawn on click per purchase</div>
      <div class="desc">current extra: <span id="swishLevelDisplay">0</span></div>
    </div>
    <div>
      <div class="upgrade-cost" id="swishCostText">cost: 100000</div>
      <button id="buySwishBtn" style="margin-top:8px;padding:8px 12px;font-size:0.9rem;">buy</button>
    </div>
  </div>

  <div style="height:12px"></div>
  <div style="text-align:center;color:#666;font-size:0.95rem;">
    tip: upgrades sorted cheapest → most expensive. orb of beetle crushing automatically pops beetles when placed over them.
  </div>
</div>

<!-- visuals & modals -->
<div id="comboDisplay"></div>
<div id="flash"></div>
<div id="goldFlash"></div>

<!-- intro modal (blocking until dismissed) -->
<div id="infoModal">
  <p>Click your way through an ever-growing swarm of beetles to collect points, <br>unlock wild upgrades, and chase the all-powerful Beetle Gems.
Every gem earned shakes the world in a burst of color, <b></b> proving your dominance on the leaderboard.&gt;</p>
  <button id="closeModal">let's play!</button>
</div>

<div id="raveText" style="display:none;">x2 wags!</div>
<div id="raveModal">
  <div class="rave-title">start the rave</div>
  <div style="margin:12px 0;">are you ready to start the 1:48 beat?</div>
  <button id="startRaveBtn"> start the rave</button>
</div>

<!-- white can (hidden until bought) -->
<div id="whiteCan" style="display:none;"><img id="whiteCanImg" src="orb.png" alt="orb" /></div></div>

<!-- sounds -->
<audio id="clickSound" src="https://freesound.org/data/previews/341/341695_62468-lq.mp3"></audio>
<audio id="upgradeSound" src="https://freesound.org/data/previews/256/256113_3263906-lq.mp3"></audio>
<audio id="comboSound" src="https://freesound.org/data/previews/144/144689_2221220-lq.mp3"></audio>
<audio id="popupSound" src="https://freesound.org/data/previews/276/276031_5121236-lq.mp3"></audio>
<audio id="adSound" src="https://freesound.org/data/previews/341/341695_62468-lq.mp3"></audio>
<audio id="bellChime" src="https://freesound.org/data/previews/341/341695_62468-lq.mp3"></audio>
<audio id="goldChime" src="https://freesound.org/data/previews/186/186942_2394245-lq.mp3"></audio>
<!-- your local bg music file (put song.mp3 in same folder) -->
<audio id="bgMusic" src="song.mp3"></audio>

<script>
/* ---------- state ---------- */
let score = 0;
let pointsPerClick = 1;
let upgradeCost = 50;            // default combo upgrade base
let baseCombo = 1;
let comboMultiplier = 1;
let comboActive = false;
let comboTimer = null;
const comboTimeoutMs = 3200;     // reduced time to make combos harder

// goon pricing uses baseCombo * 200
let goonCost = baseCombo * 200;

// swishies: start 100000 and multiply by 10 each time
let swishLevel = 0;
let swishCost = 100000;
const swishBuyMultiplier = 10;

// midas
const baseGoldenChance = 1/25; // ~4%
let midasChancePercent = 0;
let midasCost = 500;
const midasBuyMultiplier = 1.5;
const midasPercentPerBuy = 5;
const maxMidasPercent = 100;

// music (rave) — purchasable multiple times, cost each = baseCombo * 2000
let musicOwnedCount = 0;
const musicCostMultiplier = 2000; // price = baseCombo * 2000

// orb of beetle crushing
let whiteLevel = 0;
let whiteCost = 20000;
const whiteBuyMultiplier = 1.5;
let whiteCanSize = 72;
let whiteBuildBaseMs = 500;    // base build time (ms) - 0.5s base

// golden image
const goldenImage = "gold.png";

/* goon images */
const goonImagePool = ["mag.png"];

/* active lists */
const activeGoonCorners = []; // { element, x, y, timeoutId }
let activePopups = [];       // { element, timeoutId, isGolden, size, x, y, hoverTime }

/* performance settings */
const MAX_POPUPS = 30;       // cap to avoid lag
const POPUP_BASE_LIFETIME = 900; // base ms (reduced to make it harder)
const POPUP_GOLD_EXTRA_LIFETIME = 500;
const POPUP_GOON_PROX_BONUS = 600; // extra life if near goon
const POPUP_FADE_OUT_MS = 260;

/* DOM refs */
const scoreDisplay = document.getElementById("score");
const clickBtn = document.getElementById("clickBtn");
const comboDisplay = document.getElementById("comboDisplay");
const flash = document.getElementById("flash");
const goldFlash = document.getElementById("goldFlash");
const infoModal = document.getElementById("infoModal");
const closeModal = document.getElementById("closeModal");
const clickSound = document.getElementById("clickSound");
const upgradeSound = document.getElementById("upgradeSound");
const comboSound = document.getElementById("comboSound");
const popupSound = document.getElementById("popupSound");
const adSound = document.getElementById("adSound");
const bellChime = document.getElementById("bellChime");
const goldChime = document.getElementById("goldChime");
const bgMusic = document.getElementById("bgMusic");

/* upgrades UI */
const panelToggle = document.getElementById("panelToggle");
const upgradePanel = document.getElementById("upgradePanel");
const upgradeDefaultBtn = document.getElementById("upgradeDefaultBtn");
const upgradeCostText = document.getElementById("upgradeCostText");
const baseComboDisplay = document.getElementById("baseComboDisplay");
const goonCostText = document.getElementById("goonCostText");
const buyGoonBtn = document.getElementById("buyGoonBtn");
const midasCostText = document.getElementById("midasCostText");
const buyMidasBtn = document.getElementById("buyMidasBtn");
const midasChanceDisplay = document.getElementById("midasChanceDisplay");
const swishCostText = document.getElementById("swishCostText");
const buySwishBtn = document.getElementById("buySwishBtn");
const swishLevelDisplay = document.getElementById("swishLevelDisplay");
const musicCostText = document.getElementById("musicCostText");
const buyMusicBtn = document.getElementById("buyMusicBtn");
const musicOwnedCountEl = document.getElementById("musicOwnedCount");
const raveModal = document.getElementById("raveModal");
const startRaveBtn = document.getElementById("startRaveBtn");
const raveText = document.getElementById("raveText");

const buyWhiteBtn = document.getElementById("buyWhiteBtn");
const whiteCostTextEl = document.getElementById("whiteCostText");
const whiteLevelDisplayEl = document.getElementById("whiteLevelDisplay");
const whiteCanEl = document.getElementById("whiteCan");
const whiteCanImg = document.getElementById("whiteCanImg");

/* audio helper */
function playSound(sound){
  try{ sound.currentTime = 0; sound.play(); } catch(e){}
}
function playBell(){ playSound(bellChime); }

/* update UI */
function updateDisplay(){
  scoreDisplay.innerHTML = `beetles <img src="beetle.png" height="50" style="vertical-align:middle; filter: drop-shadow(0 0 1px #000);"> ${score}`;
  baseComboDisplay.textContent = baseCombo;
  upgradeCostText.textContent = `cost: ${upgradeCost}`;
  goonCost = baseCombo * 200;
  goonCostText.textContent = `cost: ${goonCost}`;
  midasCostText.textContent = `cost: ${midasCost}`;
  midasChanceDisplay.textContent = `${Math.min(midasChancePercent, maxMidasPercent)}%`;
  swishCostText.textContent = `cost: ${swishCost}`;
  swishLevelDisplay.textContent = swishLevel;
  musicCostText.textContent = `cost: ${baseCombo * musicCostMultiplier}`;
  musicOwnedCountEl.textContent = musicOwnedCount;
  whiteCostTextEl.textContent = whiteCost;
  whiteLevelDisplayEl.textContent = whiteLevel;
}

/* panel toggle */
panelToggle.addEventListener("click", () => {
  const open = upgradePanel.classList.toggle("open");
  upgradePanel.setAttribute("aria-hidden", !open);
  playBell();
});

/* modal close: "let's play" */
closeModal.addEventListener("click", () => {
  infoModal.style.display = "none";
  playBell();
});

/* visual fx */
function shakeScreen(){ document.body.classList.add("shake"); setTimeout(()=>document.body.classList.remove("shake"),250); }
function flashColor(){ const colors=['#ffd7a6','#d2a679','#ffb57a','#e3a857','#ff8c42']; flash.style.background=colors[Math.floor(Math.random()*colors.length)]; flash.style.opacity=0.6; setTimeout(()=>flash.style.opacity=0,120); }

/* spawn particles (lightweight) */
function spawnParticles(x,y,amount=8, hue=null){
  amount = Math.min(amount, 22);
  for(let i=0;i<amount;i++){
    const p = document.createElement("div");
    p.classList.add("particle");
    const size = 6 + Math.random()*8;
    p.style.width = p.style.height = size + "px";
    if(hue === "gold"){
      p.style.background = "hsl(" + (Math.random()*40 + 40) + ", 90%, 60%)";
      p.style.boxShadow = "0 0 8px rgba(255,220,120,0.9)";
    } else {
      p.style.background = "hsl(" + (Math.random()*360) + ",70%,80%)";
    }
    p.style.left = x + "px";
    p.style.top = y + "px";
    document.body.appendChild(p);
    const angle = Math.random()*2*Math.PI, distance = Math.random()*80+20, duration = 400+Math.random()*600;
    const dx = Math.cos(angle)*distance, dy = Math.sin(angle)*distance;
    p.style.transition = `transform ${duration}ms cubic-bezier(.2,.9,.2,1), opacity ${duration}ms linear`;
    requestAnimationFrame(()=>{ p.style.transform = `translate(${dx}px, ${dy}px) scale(0.2)`; p.style.opacity = 0; });
    setTimeout(()=>p.remove(), duration + 80);
  }
}

/* central combo visuals */
function showComboText(emphasize=false){
  comboDisplay.style.opacity = 1;
  comboDisplay.style.transform = "translate(-50%, -50%) scale(" + (emphasize ? 1.22 : 1.06) + ")";
  comboDisplay.textContent = "combo x" + comboMultiplier;
  comboDisplay.classList.add("combo-wiggle");
  setTimeout(()=>comboDisplay.classList.remove("combo-wiggle"),420);
}
function hideComboText(){ comboDisplay.style.opacity = 0; }

/* ---------- spawn position with goon bias ---------- */
function getPopupSpawnPosition(popupSize=100){
  const hasGoon = activeGoonCorners.length > 0;
  if(hasGoon && Math.random() < 0.72){
    const g = activeGoonCorners[Math.floor(Math.random()*activeGoonCorners.length)];
    const radius = 120;
    const angle = Math.random()*Math.PI*2;
    const r = Math.random()*radius;
    const x = Math.min(Math.max(g.x + Math.cos(angle)*r, 8), window.innerWidth - popupSize - 8);
    const y = Math.min(Math.max(g.y + Math.sin(angle)*r, 8), window.innerHeight - popupSize - 8);
    return {x, y};
  } else {
    const x = Math.random()*(window.innerWidth - popupSize - 8) + 8;
    const y = Math.random()*(window.innerHeight - popupSize - 8) + 8;
    return {x, y};
  }
}

/* compute lifetime for popup (reduced so harder) */
function computePopupLifetime(posX, posY, size, isGolden){
  let lifetime = POPUP_BASE_LIFETIME + (isGolden ? POPUP_GOLD_EXTRA_LIFETIME : 0);
  for(const g of activeGoonCorners){
    const dx = (posX + size/2) - g.x;
    const dy = (posY + size/2) - g.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < 160){
      lifetime += POPUP_GOON_PROX_BONUS;
      break;
    }
  }
  return lifetime;
}

/* ---------- popup spawning (optimized) ---------- */
function spawnPopup({isGolden=false, fromClick=false} = {}){
  // cap total popups
  if(activePopups.length >= MAX_POPUPS){
    const oldest = activePopups.shift();
    if(oldest && oldest.element){
      try { clearTimeout(oldest.timeoutId); } catch(e){}
      try { oldest.element.remove(); } catch(e){}
    }
  }

  playSound(popupSound);
  const wrapper = document.createElement("div");
  wrapper.classList.add("popup");
  if(isGolden) wrapper.classList.add("golden");
  const img = document.createElement("img");
  img.draggable = false;
  if(isGolden){
    img.src = goldenImage;
  } else {
    img.src = "beetle.png";
  }
  wrapper.appendChild(img);

  const size = isGolden ? 240 : 200;
  const pos = getPopupSpawnPosition(size);
  wrapper.style.left = pos.x + "px";
  wrapper.style.top = pos.y + "px";
  wrapper.style.width = size + "px";
  wrapper.style.height = size + "px";
  document.body.appendChild(wrapper);
  wrapper.style.transform = "scale(0.95)";
  requestAnimationFrame(()=>{ wrapper.classList.add("show"); wrapper.style.transform = "scale(1)"; });

  let clicked = false;
  const popupData = { element: wrapper, timeoutId: null, isGolden, size, x: pos.x, y: pos.y, hoverTime: 0 };
  activePopups.push(popupData);

  // set lifetime using helper
  const lifetime = computePopupLifetime(pos.x, pos.y, size, isGolden);
  popupData.timeoutId = setTimeout(()=> {
    if(!clicked){
      wrapper.classList.remove("show");
      setTimeout(()=>{ try{ wrapper.remove(); }catch(e){}; activePopups = activePopups.filter(p => p.element !== wrapper); }, POPUP_FADE_OUT_MS);
    }
  }, lifetime);

  wrapper.addEventListener("click", (e)=>{
    if(clicked) return;
    clicked = true;
    clearTimeout(popupData.timeoutId);
    try{ wrapper.remove(); } catch(e){}
    activePopups = activePopups.filter(p => p.element !== wrapper);
    refreshAllPopupTimers();

    // golden vs normal behavior
    if(isGolden){
      if(!comboActive){ comboActive = true; comboMultiplier = baseCombo + 1; }
      comboMultiplier += 3; // golden adds +3
      goldFlash.style.opacity = 1;
      setTimeout(()=>{ goldFlash.style.opacity = 0; }, 700);
      spawnParticles(e.clientX, e.clientY, 30, "gold");
      playSound(goldChime);
      shakeScreen();
      goldenPermanentPush(e.clientX, e.clientY, 180);
      showComboText(true);
    } else {
      playSound(clickSound);
      showComboText();
    }

    // trigger combo visuals and reset combo timer
    triggerCombo(e.clientX, e.clientY);
  });
}

/* ---------- refresh all popup timers (reset fade timers when a popup is clicked) ---------- */
function refreshAllPopupTimers(){
  activePopups.forEach(p => {
    try {
      clearTimeout(p.timeoutId);
      const lifetime = computePopupLifetime(p.x, p.y, p.size, p.isGolden);
      p.timeoutId = setTimeout(()=> {
        p.element.classList.remove("show");
        setTimeout(()=>{ try{ p.element.remove(); }catch(e){}; activePopups = activePopups.filter(pp => pp.element !== p.element); }, POPUP_FADE_OUT_MS);
      }, lifetime);
    } catch(e){}
  });
}

/* ---------- golden permanent push: nudges other popups outward and updates positions ---------- */
function goldenPermanentPush(cx, cy, radius=180){
  const affected = [];
  activePopups.forEach(p => {
    const el = p.element;
    try {
      const rect = el.getBoundingClientRect();
      const px = rect.left + rect.width/2;
      const py = rect.top + rect.height/2;
      const dx = px - cx, dy = py - cy;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < radius && dist > 8){
        const pushStrength = (1 - dist / radius) * 120;
        const angleJitter = (Math.random() - 0.5) * 0.6;
        const angle = Math.atan2(dy, dx) + angleJitter;
        const tx = Math.cos(angle) * pushStrength;
        const ty = Math.sin(angle) * pushStrength;
        affected.push({ p, tx, ty });
      }
    } catch(e){}
  });

  affected.forEach(a => {
    const el = a.p.element;
    const rect = el.getBoundingClientRect();
    const newLeft = Math.min(Math.max(rect.left + a.tx, 8), window.innerWidth - rect.width - 8);
    const newTop = Math.min(Math.max(rect.top + a.ty, 8), window.innerHeight - rect.height - 8);
    const dx = newLeft - rect.left;
    const dy = newTop - rect.top;
    el.animate([ { transform: "translate(0px,0px)" }, { transform: "translate(" + dx + "px," + dy + "px)" } ], { duration: 360, easing: "cubic-bezier(.2,.8,.2,1)", fill: "forwards" });
    setTimeout(()=> {
      try { el.style.left = newLeft + "px"; el.style.top = newTop + "px"; } catch(e){}
      try { a.p.x = newLeft; a.p.y = newTop; } catch(e){}
    }, 370);
  });
}

/* ---------- combo logic ---------- */
function triggerCombo(x,y){
  playSound(comboSound);
  shakeScreen();
  flashColor();
  spawnParticles(x || (window.innerWidth/2), y || (window.innerHeight/2), 8 + comboMultiplier*2);
  showComboText();
  if(!comboActive){
    comboActive = true;
    comboMultiplier = baseCombo + 1;
  } else {
    comboMultiplier++;
  }
  updateDisplay();
  clearTimeout(comboTimer);
  comboTimer = setTimeout(()=>{ resetCombo(); }, comboTimeoutMs);
}
function resetCombo(){
  comboActive = false;
  comboMultiplier = baseCombo;
  document.body.style.background = "linear-gradient(135deg, #ffd7a6, #d2a679)";
  hideComboText();
  updateDisplay();
}

/* ---------- upgrades handlers ---------- */
upgradeDefaultBtn.addEventListener("click", () => {
  if(score >= upgradeCost){
    score -= upgradeCost;
    baseCombo++;
    comboMultiplier = baseCombo;
    upgradeCost = Math.floor(upgradeCost * 2.5);
    goonCost = baseCombo * 200;
    updateDisplay();
    playSound(upgradeSound);
    playBell();
  } else { alert("not enough points!"); }
    if(typeof window.savePlayerData === "function") window.savePlayerData();
});

buyGoonBtn.addEventListener("click", () => {
  const currentGoonPrice = baseCombo * 200;
  if(score >= currentGoonPrice){
    score -= currentGoonPrice;
    createGoonCorner();
    updateDisplay();
    playSound(upgradeSound);
    playBell();
  } else { alert("not enough points!"); }
    if(typeof window.savePlayerData === "function") window.savePlayerData();
});

buyMidasBtn.addEventListener("click", () => {
  if(score >= midasCost){
    score -= midasCost;
    midasChancePercent = Math.min(maxMidasPercent, midasChancePercent + midasPercentPerBuy);
    midasCost = Math.ceil(midasCost * midasBuyMultiplier);
    updateDisplay();
    playSound(upgradeSound);
    playBell();
  } else { alert("not enough points!"); }
    if(typeof window.savePlayerData === "function") window.savePlayerData();
});

buySwishBtn.addEventListener("click", () => {
  if(score >= swishCost){
    score -= swishCost;
    swishLevel++;
    swishCost = Math.ceil(swishCost * swishBuyMultiplier);
    updateDisplay();
    playSound(upgradeSound);
    playBell();
  } else { alert("not enough points!"); }
    if(typeof window.savePlayerData === "function") window.savePlayerData();
});

/* music purchase: buy multiple times; each purchase cost = baseCombo * 2000 */
buyMusicBtn.addEventListener("click", () => {
  const price = baseCombo * musicCostMultiplier;
  if(score >= price){
    score -= price;
    musicOwnedCount++;
    updateDisplay();
    playSound(upgradeSound);
    playBell();
    // show the modal to allow user to start the rave immediately
    raveModal.style.display = "block";
  } else { alert("not enough points!"); }
    if(typeof window.savePlayerData === "function") window.savePlayerData();
});

/* buy orb of beetle crushing (cost 20k, x1.5 each buy) */
buyWhiteBtn.addEventListener("click", () => {
  if(score >= whiteCost){
    score -= whiteCost;
    whiteLevel++;
    whiteCost = Math.ceil(whiteCost * whiteBuyMultiplier);
    ensureWhiteCan();
    updateDisplay();
    playSound(upgradeSound);
    playBell();
  } else { alert("not enough points!"); }
    if(typeof window.savePlayerData === "function") window.savePlayerData();
});

/* ---------- create beetle magnet ---------- */
function createGoonCorner(){
  const src = "mag.png";
  const el = document.createElement("div");
  el.classList.add("goon-corner");
  const img = document.createElement("img");
  img.src = src;
  img.draggable = false;
  el.appendChild(img);
  const label = document.createElement("div");
  label.classList.add("goon-label");
  label.textContent = "beetle magnet";
  el.appendChild(label);
  const w = 160, h = 160;
  const x = Math.random()*(window.innerWidth - w - 24) + 12;
  const y = Math.random()*(window.innerHeight - h - 24) + 12;
  el.style.left = x + "px";
  el.style.top = y + "px";
  el.style.opacity = "0";
  document.body.appendChild(el);
  requestAnimationFrame(()=>{ el.style.opacity = "1"; el.style.transform = "scale(1)"; });
  const centerX = x + w/2, centerY = y + h/2;
  const timeoutId = setTimeout(()=> {
    el.style.opacity = "0";
    setTimeout(()=> { try{ el.remove(); } catch(e){}; }, 420);
    const idx = activeGoonCorners.findIndex(g => g.element === el);
    if(idx !== -1) activeGoonCorners.splice(idx,1);
  }, 20000 + Math.floor(Math.random()*5000));
  activeGoonCorners.push({ element: el, x: centerX, y: centerY, timeoutId });
  spawnParticles(centerX, centerY, 12);
}

/* ---------- ad logic (kept) ---------- */
function spawnAd(){
  const ad = document.createElement("div");
  ad.classList.add("ad");
  const iframe = document.createElement("iframe");
  iframe.src = "https://www.youtube.com/embed/QSjYpZCP6I0?autoplay=1&mute=1";
  iframe.frameBorder = "0";
  iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
  ad.appendChild(iframe);
  const closeBtn = document.createElement("button");
  closeBtn.classList.add("ad-close");
  closeBtn.textContent = "×";
  ad.appendChild(closeBtn);
  const x = Math.random()*(window.innerWidth-160), y = Math.random()*(window.innerHeight-140);
  ad.style.left = x + "px";
  ad.style.top = y + "px";
  document.body.appendChild(ad);
  closeBtn.addEventListener("click", () => {
    playSound(adSound);
    playBell();
    comboMultiplier += 5;
    updateDisplay();
    comboDisplay.classList.add("combo-wiggle");
    setTimeout(()=>comboDisplay.classList.remove("combo-wiggle"),300);
    spawnParticles(x+75,y+60,20);
    ad.remove();
  });
  setTimeout(()=>{ if(ad.parentElement) ad.remove(); }, 15000);
}
//setInterval(()=>{ if(Math.random()<0.65) spawnAd(); }, 7000 + Math.random()*3000);

/* spawn periodic popups - increased chance when goons exist (reduced interval & harder lifetime) */
setInterval(()=>{
  const hasGoon = activeGoonCorners.length > 0;
  let chance = 0.4;
  if(hasGoon) chance += 0.28;
  if(Math.random() < chance) spawnPopup();
}, 700 + Math.random()*600);

/* click button behavior (with golden chance + midas + swishies) */
clickBtn.addEventListener("click", (e) => {
  const midasFraction = Math.min(midasChancePercent, maxMidasPercent) / 100;
  const finalGoldenChance = Math.min(1, baseGoldenChance + midasFraction);
  // spawn main popup (may be golden)
  const isGoldenMain = Math.random() < finalGoldenChance;
  spawnPopup({ isGolden: isGoldenMain, fromClick: true });
  // spawn extra popups due to swishLevel (always normal)
  for(let i=0;i<swishLevel;i++){ spawnPopup({ isGolden: false, fromClick: true }); }
  // calculate score increment; music doubles wags
  const multiplier = comboMultiplier * (musicActive ? 2 : 1);
  score += pointsPerClick * multiplier;
  updateDisplay();
  playSound(clickSound);
  playBell();
  // periodic save on clicks
  window._clickSaveCounter = (window._clickSaveCounter || 0) + 1;
  if(window._clickSaveCounter >= 25){ window._clickSaveCounter = 0; if(typeof window.savePlayerData === "function") window.savePlayerData(); }
});

/* Rave start handling */
let musicActive = false;
startRaveBtn.addEventListener("click", () => {
  raveModal.style.display = "none";
  try {
    bgMusic.currentTime = 0;
    bgMusic.play().catch(()=>{});
  } catch(e){}
  musicActive = true;
  document.body.classList.add("rave");
  raveText.style.display = "block";
  playBell();
});

/* When bgMusic ends, remove effects */
bgMusic.addEventListener("ended", () => {
  musicActive = false;
  document.body.classList.remove("rave");
  raveText.style.display = "none";
  playBell();
});

/* on resize, recalc goon centers */
window.addEventListener("resize", () => {
  for(const g of activeGoonCorners){
    try {
      const rect = g.element.getBoundingClientRect();
      g.x = rect.left + rect.width/2;
      g.y = rect.top + rect.height/2;
    } catch(e){}
  }
});

/* ---------- White Moinster: ensure can exists and follows mouse; builds up on popups ---------- */
function ensureWhiteCan(){
  if(!whiteCanEl) return;
  whiteCanEl.style.display = 'block';
  whiteCanSize = 72 + (whiteLevel * 10);
  whiteCanEl.style.width = whiteCanSize + 'px';
  whiteCanEl.style.height = whiteCanSize + 'px';
  whiteCanEl.style.transform = `translate(-50%,-50%) scale(${1 + whiteLevel*0.06})`;
  // start following mouse
  if(!whiteFollowStarted){
    window.addEventListener('mousemove', whiteFollowMouse);
    whiteFollowStarted = true;
    requestAnimationFrame(whiteCollisionTicker);
  }
}
let whiteFollowStarted = false;
function whiteFollowMouse(e){
  const x = e.clientX;
  const y = e.clientY;
  const left = Math.min(Math.max(8, x), window.innerWidth - whiteCanSize - 8);
  const top = Math.min(Math.max(8, y), window.innerHeight - whiteCanSize - 8);
  whiteCanEl.style.left = left + 'px';
  whiteCanEl.style.top = top + 'px';
}

/* ---------- whiteCollisionTicker: requires continuous hover for pop (adjusted by level) ---------- */
let lastWhiteTick = 0;
function whiteCollisionTicker(ts){
  const now = performance.now();
  if(!ts) ts = now;
  const dt = Math.min(80, now - lastWhiteTick || 16); // clamp dt for stability
  lastWhiteTick = now;

  if(!whiteCanEl || whiteCanEl.style.display === 'none') {
    // stop loop early
    return;
  }

  const canRect = whiteCanEl.getBoundingClientRect();
  // build time reduces with level: base 500ms down to min 120ms (fast at high levels)
  const buildTime = Math.max(120, whiteBuildBaseMs - (whiteLevel * 70));

  // iterate popups and update hover accumulation
  for(let i = activePopups.length - 1; i >= 0; i--){
    const p = activePopups[i];
    try {
      const rect = p.element.getBoundingClientRect();
      const overlapX = Math.max(0, Math.min(rect.right, canRect.right) - Math.max(rect.left, canRect.left));
      const overlapY = Math.max(0, Math.min(rect.bottom, canRect.bottom) - Math.max(rect.top, canRect.top));
      const overlap = overlapX * overlapY > 0;

      if(overlap){
        // accumulate hover time by dt (ms)
        p.hoverTime = (p.hoverTime || 0) + dt;
        // continuous rumble scaled to progress
        const progress = Math.min(1, p.hoverTime / buildTime);
        const rumble = 8 + 8 * progress;
        const angle = Math.sin(Date.now()/30) * rumble;
        p.element.style.transform = `rotate(${angle}deg) scale(${1 + 0.06*progress})`;

        if(p.hoverTime >= buildTime){
          // pop immediately
          const wasGolden = p.isGolden;
          try{ clearTimeout(p.timeoutId); }catch(e){}
          try{ p.element.remove(); }catch(e){}
          activePopups.splice(i,1);

          const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
          if(wasGolden){
            if(!comboActive){ comboActive = true; comboMultiplier = baseCombo + 1; }
            comboMultiplier += 3;
            goldFlash.style.opacity = 1;
            setTimeout(()=>{ goldFlash.style.opacity = 0; }, 700);
            spawnParticles(cx, cy, 28, "gold");
            playSound(goldChime);
            shakeScreen();
            goldenPermanentPush(cx, cy, 160);
            showComboText(true);
          } else {
            playSound(clickSound);
            showComboText();
          }

          triggerCombo(cx, cy);
          refreshAllPopupTimers();
        }
      } else {
        // reset hover time if contact is broken
        p.hoverTime = 0;
        p.element.style.transform = '';
      }
    } catch(e){}
  }

  // continue loop
  if(whiteCanEl && whiteCanEl.style.display !== 'none'){
    requestAnimationFrame(whiteCollisionTicker);
  }
}

/* ---------- utility: limit runaway DOM by cleaning invisible popups periodically ---------- */
setInterval(()=> {
  if(activePopups.length > MAX_POPUPS){
    const excess = activePopups.length - MAX_POPUPS;
    for(let i=0;i<excess;i++){
      const p = activePopups.shift();
      try { if(p.timeoutId) clearTimeout(p.timeoutId); if(p.element) p.element.remove(); } catch(e){}
    }
  }
  activePopups = activePopups.filter(p => document.body.contains(p.element));
}, 1500);

/* ---------- initialization ---------- */
comboMultiplier = baseCombo;
updateDisplay();

// ensure intro modal is focusable
closeModal.focus();

// ensure white can element exists in DOM reference
// (element already present in markup with id 'whiteCan')
if(whiteCanEl) {
  // nothing (whiteCanEl already a reference)
} else {
  // if not found, grab it now
  // (should exist by markup)
}
</script>

<!-- ======= BEGIN Leaderboard & Username Integration (FIXED) ======= -->
<style>
/* leaderboard styles */
#leaderboardPanel {
  position: fixed;
  left: -420px;
  top: 0;
  width: 420px;
  height: 100%;
  background: #fff;
  box-shadow: 8px 0 24px rgba(0,0,0,0.2);
  opacity: 0.5;
  transition: left 0.3s ease;
  z-index: 99999;
  padding: 20px;
  overflow-y: auto;
  color: #000;
}
#leaderboardPanel.open { left: 0; }
#leaderboardPanel h2 { text-align: center; margin-top: 0; }
#leaderboardList li { padding: 8px 0; border-bottom: 1px solid #ddd; list-style:none; }
#usernameModal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.75);
  display: flex; align-items: center; justify-content: center;
  z-index: 100000;
  pointer-events: auto;
}
#usernameBox { opacity: 0.95;
  background: #fff; padding: 30px; border-radius: 15px;
  text-align: center; max-width: 340px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
#usernameBox input {
  font-size: 1.2rem; padding: 10px; width: 80%;
  text-transform: uppercase; letter-spacing: 3px; text-align: center;
}
#leaderboardToggle {
  position: fixed; left: 18px; top: 18px;
  width: 48px; height: 48px; border-radius: 12px;
  z-index: 100001; font-size: 1.5rem; cursor: pointer;
}
#changeUsernameBtn { margin-top:10px; padding:6px 10px; }
</style>

<div id="leaderboardPanel" aria-hidden="true">
  <h2>Top 5 Players</h2>
  <ul id="leaderboardList"></ul>
  <p style="text-align:center;">Your username: <strong id="lbCurrentName">---</strong></p>
  <div style="text-align:center;"><button id="changeUsernameBtn">Change Username</button></div>
</div>

<button id="leaderboardToggle" title="leaderboard"></button>

<div id="usernameModal" aria-modal="true" role="dialog">
  <div id="usernameBox">
    <h2 style="margin:0 0 8px 0;">Enter your 5-letter name & 6-digit PIN</h2>
    <input id="usernameInput" maxlength="5" placeholder="ABCDE" aria-label="username input" style="display:block;margin:8px auto;font-size:1.1rem;padding:8px;text-transform:uppercase;text-align:center;width:80%" />
    <input id="pinInput" maxlength="6" placeholder="123456" aria-label="pin input" style="display:block;margin:8px auto;font-size:1.1rem;padding:8px;text-align:center;width:80%" />
    <div style="margin-top:10px;">
      <button id="usernameConfirm">Confirm</button>
      <button id="usernameRandom">Random</button>
    </div>
    <p style="margin-top:10px;color:#666;font-size:0.9rem;text-align:center;">If the name exists, the PIN will log you into it. If not, a new account will be created with that PIN.</p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, child, update } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

// Firebase config (kept)
const firebaseConfig = {
  apiKey: "AIzaSyDh85Pd2VBdDVGrLCGr7sJAQSSClivAwO8",
  authDomain: "clickergame-beba8.firebaseapp.com",
  databaseURL: "https://clickergame-beba8-default-rtdb.firebaseio.com",
  projectId: "clickergame-beba8",
  storageBucket: "clickergame-beba8.firebasestorage.app",
  messagingSenderId: "189673552883",
  appId: "1:189673552883:web:e5633ce381280cc00ab086",
  measurementId: "G-Q3X4ML34RD"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
// expose firebase objects for other scripts
window.app = app;
window.db = db;
window.ref = ref;
window.set = set;
window.get = get;
window.onValue = onValue;
window.child = child;
window.update = update;

// DOM refs
const lbPanel = document.getElementById("leaderboardPanel");
const lbList = document.getElementById("leaderboardList");
const lbToggle = document.getElementById("leaderboardToggle");
const usernameModal = document.getElementById("usernameModal");
const usernameInput = document.getElementById("usernameInput");
const pinInput = document.getElementById("pinInput");
const usernameConfirm = document.getElementById("usernameConfirm");
const usernameRandom = document.getElementById("usernameRandom");
const changeUsernameBtn = document.getElementById("changeUsernameBtn");
const infoModalEl = document.getElementById("infoModal");

lbToggle.addEventListener("click", ()=> lbPanel.classList.toggle("open"));

// helpers
async function readUserRecord(name){
  try{
    const snap = await get(ref(db, "scores/" + name));
    return snap && snap.exists() ? snap.val() : null;
  }catch(e){ console.error("readUserRecord error", e); return null; }
}

function randomName(){
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  let out = "";
  for(let i=0;i<5;i++) out += letters[Math.floor(Math.random()*letters.length)];
  return out;
}

// global session state for this module
let username = null;
let pin = null;
let lastSaved = null;

// default template for a new user
function defaultPlayerObject(name, pinCode){
  return {
    name: name,
    pin: pinCode,
    score: 0,
    leaderboardTokens: 0,
    baseCombo: 1,
    swishLevel: 0,
    whiteLevel: 0,
    midasChancePercent: 0,
    musicOwnedCount: 0
  };
}

// apply loaded data into the game's global variables
function loadPlayerData(obj){
  if(!obj) return;
  // these global variables exist in the main script; assign them
  try{
    window.score = Number(obj.score) || 0;
    window.leaderboardTokens = Number(obj.leaderboardTokens) || 0;
    window.baseCombo = Number(obj.baseCombo) || 1;
    window.swishLevel = Number(obj.swishLevel) || 0;
    window.whiteLevel = Number(obj.whiteLevel) || 0;
    window.midasChancePercent = Number(obj.midasChancePercent) || 0;
    window.musicOwnedCount = Number(obj.musicOwnedCount) || 0;
    // ensure any dependent costs/locks are recalculated by the game's updateDisplay()
    if(typeof window.updateDisplay === "function") window.updateDisplay();
    // ensure white can visibility and size update if needed
    if(window.ensureWhiteCan && window.whiteLevel > 0) window.ensureWhiteCan();
  }catch(e){ console.error("loadPlayerData error", e); }
}

// save full player object to Firebase under their username
async function savePlayerData(){
  if(!username) return;
  try{
    const dbInst = (typeof getDatabase === 'function' && typeof app !== 'undefined') ? getDatabase(app) : window.db;
    const payload = {
      name: username,
      pin: pin,
      score: Number(window.score) || 0,
      leaderboardTokens: Number(window.leaderboardTokens) || 0,
      baseCombo: Number(window.baseCombo) || 1,
      swishLevel: Number(window.swishLevel) || 0,
      whiteLevel: Number(window.whiteLevel) || 0,
      midasChancePercent: Number(window.midasChancePercent) || 0,
      musicOwnedCount: Number(window.musicOwnedCount) || 0
    };
    try{
      console.log("Saving to Firebase:", "scores/" + username, payload);
      await set(ref(dbInst, "scores/" + username), payload);
      lastSaved = Date.now();
      if(typeof window.showSaveStatus === 'function') window.showSaveStatus("Saved ✓", true);
      console.log("✅ Save complete");
    }catch(saveErr){
      if(typeof window.showSaveStatus === 'function') window.showSaveStatus("Save failed ✕", false);
      console.error("❌ Firebase write failed:", saveErr);
    }
  }catch(e){
    console.error("savePlayerData outer error", e);
  }
}

// push token count only used by older code; keep for compatibility
async function pushLeaderboardTokens(){
  if(!username) return;
  try{
    await set(ref(db, "scores/" + username), {
      name: username,
      pin: pin,
      score: Number(window.score)||0,
      leaderboardTokens: Number(window.leaderboardTokens)||0,
      baseCombo: Number(window.baseCombo)||1,
      swishLevel: Number(window.swishLevel)||0,
      whiteLevel: Number(window.whiteLevel)||0,
      midasChancePercent: Number(window.midasChancePercent)||0,
      musicOwnedCount: Number(window.musicOwnedCount)||0
    });
  }catch(e){ console.error("pushLeaderboardTokens error", e); }
}

// Init: if saved username+pin in localStorage, try to auto-login
(async function initUsername(){
  // Always require fresh login (no localStorage)
  usernameModal.style.display = "flex";
  usernameInput.focus();
})();
// Confirm handler: create or login based on existence & pin
// Random name fill (doesn't set pin)
usernameRandom.addEventListener("click", async ()=>{
  const candidate = randomName();
  usernameInput.value = candidate;
  pinInput.focus();
});

// change username button (requires entering current pin again)
if(changeUsernameBtn){
  changeUsernameBtn.addEventListener("click", async ()=>{
    if(!username){ alert("You must be logged in to change your username."); return; }
    const newNameRaw = prompt("Enter a new 5-letter username:","").toUpperCase().trim();
    if(!newNameRaw || !/^[A-Z]{5}$/.test(newNameRaw)){ alert("Must be exactly 5 letters (A-Z)."); return; }
    if(newNameRaw === username){ alert("That's already your current name."); return; }
    const exists = await readUserRecord(newNameRaw);
    if(exists){ alert("That username is taken. Choose another."); return; }
    try{
      // copy current data to new key, then remove old key
      const dataSnap = await readUserRecord(username);
      if(!dataSnap){ alert("Current account missing."); return; }
      dataSnap.name = newNameRaw;
      await set(ref(db, "scores/" + newNameRaw), dataSnap);
      await set(ref(db, "scores/" + username), null);
      // update local session
      username = newNameRaw;
      alert("Username changed to " + username);
    }catch(e){ console.error("change username error", e); alert("Failed to change username."); }
  });
}

// Leaderboard live updates (sorted by leaderboardTokens)
onValue(ref(db, "scores"), (snapshot)=>{
  const data = snapshot.val() || {};
  const arr = Object.values(data).map(v=>({name:v.name, tokens:Number(v.leaderboardTokens)||0}));
  arr.sort((a,b)=>b.tokens - a.tokens);
  const top = arr.slice(0,5);
  lbList.innerHTML = top.map((p,i)=>`<li><strong>${i+1}. ${p.name}</strong> — ${p.tokens} <img src='https://static.wikia.nocookie.net/fantendo/images/7/7f/gem.png/revision/latest/scale-to-width-down/250?cb=20150316234554' style='width:1em;height:1em;vertical-align:middle;'></li>`).join("");
});

// Confirm handler (module-scoped) - login or create user in Firebase (no localStorage)
usernameConfirm.addEventListener("click", async ()=>{
  const rawName = (usernameInput.value||"").trim().toUpperCase();
  const rawPin = (pinInput.value||"").trim();
  if(!/^[A-Z]{5}$/.test(rawName)){ alert("Must be exactly 5 letters (A-Z) for username."); return; }
  if(!/^[A-Za-z0-9]{6}$/.test(rawPin)){ alert("PIN must be exactly 6 letters/numbers."); return; }
  try{
    const dbInst = (typeof getDatabase === 'function' && typeof app !== 'undefined') ? getDatabase(app) : window.db;
    const snap = await get(ref(dbInst, "scores/" + rawName));
    if(snap && snap.exists()){
      const existing = snap.val();
      if(existing.pin === rawPin){
        username = rawName; pin = rawPin;
        loadPlayerData(existing);
        usernameModal.style.display = "none";
        document.getElementById("lbCurrentName").textContent = username;
        startAutoSave();
        await savePlayerData();
        alert("Welcome back, " + username + "!");
        return;
      } else {
        alert("Incorrect PIN for that username.");
        return;
      }
    } else {
      username = rawName; pin = rawPin;
      const newObj = defaultPlayerObject(username, pin);
      await set(ref(dbInst, "scores/" + username), newObj);
      loadPlayerData(newObj);
      usernameModal.style.display = "none";
      document.getElementById("lbCurrentName").textContent = username;
      startAutoSave();
      await savePlayerData();
      alert("Account created: " + username);
      return;
    }
  }catch(err){
    console.error("Login/create error", err);
    alert("Login error, please try again.");
  }
});

// Auto-save every 10s if logged in
setInterval(()=>{ try{ if(username) savePlayerData(); }catch(e){} }, 10000);

// Expose save functions for other scripts (compat)
window.savePlayerData = savePlayerData;
window.pushLeaderboardTokens = pushLeaderboardTokens;

</script>

<!-- ======= END Leaderboard & Username Integration (FIXED) ======= -->

<!-- ======= BEGIN beetle gem Upgrade (v18 safe) ======= -->
<style>
/* beetle gem button styled warm */
#buyTokenBtn {
  background: linear-gradient(145deg, #ff8c42, #d78b3b);
  color: #fff;
  font-weight: bold;
  border: 2px solid rgba(255,200,120,0.35);
  border-radius: 12px;
  width: 95%;
  margin-top: 20px;
  padding: 12px;
  font-size: 1.05rem;
  animation: none;
  transition: transform 0.12s ease;
  z-index: 70;
}
#buyTokenBtn:hover { transform: scale(1.03); }
#purpleFadeOverlay {
  position: fixed; inset: 0;
  background: rgba(255,140,66,0.25); /* warm orange flash */
  opacity: 0; pointer-events: none;
  z-index: 9998;
  transition: opacity 0.4s ease;
}
#tokenFlyImg {
  position: fixed; width: 48px; height: 48px;
  left: 50%; top: 50%;
  transform: translate(-50%,-50%) scale(0);
  opacity: 0; z-index: 9999;
  transition: all 1s ease;
  pointer-events: none;
}
</style>

<div id="purpleFadeOverlay"></div>
<img id="tokenFlyImg" src="gem.png" alt="token">

<script>
// ===== beetle gem Logic (stable, no localStorage) =====
if(typeof window.leaderboardTokens === 'undefined') window.leaderboardTokens = 0;

function getLeaderboardTokenCost(){
  const owned = Number(window.leaderboardTokens) || 0;
  const cost = Math.min(Number.MAX_SAFE_INTEGER, Math.floor(200 * Math.pow(5, owned)));
  return cost;
}

function buyToken(){
  if(typeof score === "undefined"){ alert("Game not loaded yet."); return; }
  const cost = getLeaderboardTokenCost();
  if(score < cost){ alert("Not enough tail wags!"); return; }
  // deduct
  score -= cost;
  if (typeof updateDisplay === "function") updateDisplay();
  // increment token count and sync to global
  window.leaderboardTokens = (Number(window.leaderboardTokens) || 0) + 1;
  // persist to firebase
  if(typeof window.savePlayerData === "function") window.savePlayerData();
  // animate
  setTimeout(()=>{ if(typeof window.animateTokenPurchase === "function") window.animateTokenPurchase(); }, 80);
  // update label
  const btn = document.getElementById("buyTokenBtn");
  if(btn) btn.textContent = " Buy beetle gem (" + getLeaderboardTokenCost() + " tail wags)";
}

// create button safely when DOM ready (if not exists)
window.addEventListener('DOMContentLoaded', ()=>{
  const upgrades = document.getElementById('upgradePanel');
  if(upgrades && !document.getElementById('buyTokenBtn')){
    const btn = document.createElement('button');
    btn.id = 'buyTokenBtn';
    btn.textContent = " Buy beetle gem (" + getLeaderboardTokenCost() + " tail wags)";
    btn.addEventListener('click', buyToken);
    upgrades.appendChild(btn);
  }
});

function animateTokenPurchase(){
  const fade = document.getElementById('purpleFadeOverlay');
  const img = document.getElementById('tokenFlyImg');
  if(!fade || !img) return;
  fade.style.opacity = 1;
  img.style.opacity = 1;
  img.style.transform = 'translate(-50%,-50%) scale(1.5)';
  setTimeout(()=>{
    fade.style.opacity = 0;
    const icon = document.getElementById('leaderboardToggle');
    if(icon){
      const rect = icon.getBoundingClientRect();
      img.style.transition = 'all 1s ease-in-out';
      img.style.left = rect.left + rect.width/2 + 'px';
      img.style.top = rect.top + rect.height/2 + 'px';
      img.style.transform = 'scale(0)';
      setTimeout(()=>{
        img.style.opacity = 0;
        spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, 25, 'gold');
      }, 1000);
    }
  }, 300);
}

</script>
<!-- ======= END beetle gem Upgrade (v19) ======= -->

<style>
#saveIndicator {
  position: fixed;
  left: 50%;
  bottom: 20px;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 8px 14px;
  border-radius: 999px;
  font-family: sans-serif;
  font-size: 0.95rem;
  z-index: 999999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s ease, transform 0.35s ease;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
}
#saveIndicator.show-success { background: rgba(20,120,20,0.95); transform: translateX(-50%) translateY(0); opacity: 1; }
#saveIndicator.show-fail { background: rgba(160,30,30,0.95); transform: translateX(-50%) translateY(0); opacity: 1; }
</style>

<div id="saveIndicator" aria-hidden="true">Saved ✓</div>
<script>
window.showSaveStatus = (text, success=true) => {
  try{
    const el = document.getElementById('saveIndicator');
    if(!el) return;
    el.textContent = text || (success ? 'Saved ✓' : 'Save failed ✕');
    el.classList.remove('show-success','show-fail');
    void el.offsetWidth;
    el.classList.add(success ? 'show-success' : 'show-fail');
    clearTimeout(el._hideTimeout);
    el._hideTimeout = setTimeout(()=>{ el.classList.remove('show-success','show-fail'); }, 2000);
  }catch(e){}
};
</script>

</body>
</html>
